<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scroll Proxy</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body, html {
            width: 100%;
            height: 100%;
            overflow: hidden;
            /* Background image will be set dynamically to ensure we hit the play host for /static assets */
            background-color: #0b0b0b;
            background-size: cover;
            background-position: center center;
            background-repeat: no-repeat;
        }
        
        #content-iframe {
            width: 100%;
            height: 100%;
            overflow-y: hidden; /* Disable user scrolling */
            overflow-x: hidden;
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none; /* Disable mouse interaction with scroll */
        }
        
        #scrollable-content {
            overflow-y: hidden;
            overflow-x: hidden;
            position: relative;
            will-change: transform;
            transform-origin: top left;
        }
        
        
    </style>
</head>
<body>
    <div id="content-iframe">
        <div id="scrollable-content">Loading, if you can read this message @euanRipper on slack</div>
    </div>
    
    <script>
        // Dynamically resolve background image from play.* host (image resides in play/public/static/images/back.png)
        (function setBackground(){
            try {
                const host = window.location.hostname.replace(/^maps\./,'play.');
                const protocol = window.location.protocol === 'http:' ? 'http:' : 'https:';
                const imgUrl = protocol + '//' + host + '/static/images/back.png';
                document.body.style.backgroundImage = 'url(' + imgUrl + ')';
            } catch (e) {
                console.warn('Failed to set dynamic background', e);
            }
        })();
        const contentDiv = document.getElementById('scrollable-content');
        const TILE_SIZE = 32;
        let PLAYER_START_Y = 0; // Will be set on first movement
        let targetScroll = 0;
        let currentScroll = 0;
        let initialScrollDone = false;
        
        // Listen for messages from parent 
        window.addEventListener('message', (event) => {
            console.log('Received message:', event.data);
            
            // Handle scroll updates
            if (event.data && typeof event.data.scrollPercent === 'number') {
                targetScroll = event.data.scrollPercent;
                console.log('Updating scroll to:', targetScroll);
                updateScroll();
            }
            
            // Use hasPlayerMoved events that WorkAdventure already sends
            if (event.data && event.data.type === 'hasPlayerMoved' && event.data.data) {
                const playerY = event.data.data.y;
                
                // Init on first move because spawn position can change
                if (!initialScrollDone) {
                    console.log(`First movement - Player spawned at Y: ${Math.round(playerY)}`);
                    // Set the baseline so content starts at top (0 offset) from current position
                    PLAYER_START_Y = playerY;
                    targetScroll = 0;
                    contentDiv.style.transition = 'none';
                    updateScroll();
                    setTimeout(() => { contentDiv.style.transition = 'transform 0.1s linear'; }, 50);
                    initialScrollDone = true;
                    return;
                }
                
                
                const relativeY = playerY - PLAYER_START_Y;
                targetScroll = relativeY*1;
                
                console.log(`Player Y: ${Math.round(playerY)}, Offset: ${Math.round(targetScroll)}px`);
                updateScroll();
            }
        });
        
        function updateScroll() {
            contentDiv.style.transform = `translateY(${targetScroll}px)`;
            contentDiv.style.transition = 'transform 0.1s linear';
        }
        
    
        createScrollableContent();
        
        function createScrollableContent() {
            // Calculate correct image URL based on environment
            let imgUrl = '/static/images/back.png';
            try {
                const host = window.location.hostname.replace(/^maps\./, 'play.');
                const protocol = window.location.protocol === 'http:' ? 'http:' : 'https:';
                imgUrl = `${protocol}//${host}/static/images/back.png`;
            } catch (e) {
                console.warn('Failed to determine dynamic background URL', e);
            }

            contentDiv.innerHTML = `
                <div style="
                    padding: 40px; 
                    font-family: Arial, sans-serif; 
                    line-height: 1.6; 
                    user-select: none;
                    background-image: url('${imgUrl}');
                    background-size: cover;
                    background-position: center;
                    background-repeat: no-repeat;
                    min-height: 100vh;
                ">
                    <h1 style="color: #ff6b35; margin-bottom: 30px;"> Welcome to Flavortown!</h1>
                    <p style="color: #666; margin-bottom: 30px;">
                        Cook personal projects. Win free prizes.
                    </p>
                    
                    <div style="background: #f9f9f9; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
                        <h2 style="color: #555;">About:</h2>
                        <p style="color: #666;">
                            In our virtual world you can meet, make friends and hack on projects together.
                        </p>
                        <p style="color: #666; margin-top: 15px;">
                            You can get rewards for your projects, by travelling to the shop to get rewards in REAL LIFE!
                            <br> -Macbooks, iPads, 3d printers and more!
                            <br> We have a few rules, which you acknowledge by entering:
                        </p>
                    </div>
                    
            
                    <section style="margin-bottom: 20px; padding: 25px; background: '#fff5f0'}; border-left: 4px solid #ff6b35; border-radius: 4px; min-height: 32px;">
                        <h3 style="color: #ff6b35; margin-bottom: 15px;"> Rule 1:</h3>
                        <p style="color: #666; margin-bottom: 10px;">
                            Be thoughtful! <br> Messages sent in public are monitored and can result in a ban from flavortown and slack if they violate code of conduct.
                        </p>
                    </section>
                    <section style="margin-bottom: 20px; padding: 25px; background: '#fff'}; border-left: 4px solid #ff6b35; border-radius: 4px; min-height: 32px;">
                        <h3 style="color: #ff6b35; margin-bottom: 15px;"> Rule 2:</h3>
                        <p style="color: #666; margin-bottom: 10px;">
                            Do not attempt to fraud our code time tracking software (hackatime). No bots, scripting or faking.
                        </p>
                        
                    </section>
                    <section style="margin-bottom: 20px; padding: 25px; background: '#fff5f0'}; border-left: 4px solid #ff6b35; border-radius: 4px; min-height: 32px;">
                        <h3 style="color: #ff6b35; margin-bottom: 15px;"> Rule 3:</h3>
                        <p style="color: #666; margin-bottom: 10px;">
                            Do not invade spaces to disrupt, if people are working please keep the talk on topic / helpflul.
                        </p>
                    
                    </section>
                    <h3 style="color: #ff6b35; margin-bottom: 15px;"> By entering you agree to our Code of Conduct</h3>
                    <p>The code of conduct is summarised here</p>
                    <ul>
                    <li>Be friendly and welcoming</li>
                    <li>Be patient
                    <ul>
                    <li>Remember that people have varying communication styles and that not everyone is using their native language (meaning and tone can be lost in translation).</li>
                    </ul>
                    </li>
                    <li>Be thoughtful
                    <ul>
                    <li>Productive communication requires effort. Think about how your words will be interpreted.</li>
                    <li>Remember that sometimes it is best to refrain entirely from commenting.</li>
                    </ul>
                    </li>
                    <li>Be respectful
                    <ul>
                    <li>In particular, respect differences of opinion.</li>
                    </ul>
                    </li>
                    <li>Be charitable
                    <ul>
                    <li>Interpret the arguments of others in good faith, do not seek to disagree.</li>
                    <li>When we do disagree, try to understand why.</li>
                    </ul>
                    </li>
                    <li>Avoid destructive behavior:
                    <ul>
                    <li>Derailing: stay on topic; if you want to talk about something else, start a new conversation.</li>
                    <li>Unconstructive criticism: don't merely condemn the current state of affairs; offer—or at least solicit—suggestions as to how things may be improved.</li>
                    <li>Snarking (pithy, unproductive, sniping comments)</li>
                    <li>Discussing potentially offensive or sensitive issues; this all too often leads to unnecessary conflict.</li>
                    <li>Microaggressions: brief and commonplace verbal, behavioral, and environmental indignities that communicate hostile, derogatory or negative slights and insults to a person or group.</li>
                    </ul>
                    </li>
                    </ul>
                </div>


                    
                    
    
            `;
            
        }
    </script>
</body>
</html>
